syntax = "proto3";
option java_multiple_files = true;
package palm.plugins.nut.v1;

import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";
import "google/protobuf/duration.proto";

message Pager {
  int64 page = 1;
  int64 size = 2;
}

message Pagination {
  int64 page = 1;
  int64 size = 2;
  int64 total = 3;
  bool has_next = 11;
  bool has_previous = 12;
}

message IdRequest { int32 id = 1; }

// ----------------------------------------------------------------------------

service User {
  rpc SignIn(UserSignInRequest) returns (UserSignInResponse) {}
  rpc SignUp(UserSignUpRequest) returns (google.protobuf.Empty) {}
  rpc ConfirmByEmail(UserEmailRequest) returns (google.protobuf.Empty) {}
  rpc ConfirmByToken(UserTokenRequest) returns (google.protobuf.Empty) {}
  rpc UnlockByEmail(UserEmailRequest) returns (google.protobuf.Empty) {}
  rpc UnlockByToken(UserTokenRequest) returns (google.protobuf.Empty) {}
  rpc ForgotPassword(UserEmailRequest) returns (google.protobuf.Empty) {}
  rpc ResetPassword(UserResetPasswordRequest) returns (google.protobuf.Empty) {}

  rpc Refresh(google.protobuf.Duration) returns (UserSignInResponse) {}
  rpc Logs(Pager) returns (UserLogsResponse) {}
  rpc SetProfile(UserSetProfileRequest) returns (google.protobuf.Empty) {}
  rpc ChangePassword(UserChangePasswordRequest)
      returns (google.protobuf.Empty) {}
  rpc SignOut(google.protobuf.Empty) returns (google.protobuf.Empty) {}
}

message UserSignInResponse { string token = 1; }
message UserChangePasswordRequest {
  string current_password = 1;
  string new_password = 2;
}

message UserLogsResponse {
  message Item {
    int32 id = 1;
    int32 user_id = 2;
    string ip = 3;
    string level = 4;
    string message = 5;
    string resource_type = 6;
    optional int32 resource_id = 7;
    google.protobuf.Timestamp created_at = 11;
  }
  repeated Item items = 1;
  Pagination pagination = 9;
}

message UserResetPasswordRequest {
  string token = 1;
  string password = 2;
}

message UserQueryRequest {
  oneof id {
    string email = 1;
    string nick_name = 2;
  }
}

message UserEmailRequest {
  UserQueryRequest query = 1;
  string home = 9;
}

message UserTokenRequest { string token = 1; }

message UserSignInRequest {
  UserQueryRequest query = 1;
  string password = 2;
  google.protobuf.Duration ttl = 11;
}

message UserSignUpRequest {
  string real_name = 1;
  string nick_name = 2;
  string email = 3;
  string password = 4;
  string lang = 11;
  string time_zone = 12;
  string home = 21;
}

message UserSetProfileRequest {
  string real_name = 1;
  string avatar = 2;
  string time_zone = 8;
  string lang = 9;
  string wechat = 11;
  string phone = 12;
}

message UserGetProfileResponse {
  string real_name = 1;
  string avatar = 2;
  string nick_name = 3;
  string email = 4;
  string time_zone = 8;
  string lang = 9;
  string wechat = 11;
  string phone = 12;
}

// ----------------------------------------------------------------------------

service Role {
  rpc Index(Pager) returns (RoleIndexResponse) {}
  rpc ByUser(IdRequest) returns (RoleByUserResponse) {}
  rpc Associate(RoleUserAssociateRequest) returns (google.protobuf.Empty) {}
  rpc Unassociate(RoleUserUnassociateRequest) returns (google.protobuf.Empty) {}
  rpc Options(google.protobuf.Empty) returns (RoleOptionsResponse) {}
}
message RoleOptionsResponse { repeated PolicyOptionsResponse.Item items = 1; }
message RoleIndexResponse {
  message Item {
    int32 id = 1;
    PolicyOptionsResponse.Item role = 2;
    SiteUserIndexResponse.Item user = 3;
    google.protobuf.Timestamp created_at = 9;
  }
  repeated Item items = 1;
  Pagination pagination = 9;
}
message RoleByUserResponse { repeated PolicyOptionsResponse.Item items = 1; }
message RoleUserUnassociateRequest {
  int32 user = 1;
  string role = 2;
}
message RoleUserAssociateRequest {
  int32 user = 1;
  repeated string roles = 2;
  google.protobuf.Timestamp not_before = 11;
  google.protobuf.Timestamp expired_at = 12;
}

service Policy {
  rpc Apply(PolicyPermission) returns (google.protobuf.Empty) {}
  rpc Deny(PolicyPermission) returns (google.protobuf.Empty) {}

  rpc Index(Pager) returns (PolicyIndexResponse) {}

  rpc Options(google.protobuf.Empty) returns (PolicyOptionsResponse) {}
}

message PolicyPermission {
  string role = 1;
  string operation = 2;
  string resource_type = 3;
  optional int32 resource_id = 4;
}

message PolicyOptionsResponse {
  message Item {
    string code = 1;
    string label = 2;
  }
  repeated Item roles = 1;
  repeated Item operations = 2;
  repeated Item resources = 3;
}

message PolicyIndexResponse {
  message Item {
    int32 id = 1;
    PolicyOptionsResponse.Item role = 2;
    PolicyOptionsResponse.Item operation = 3;
    PolicyOptionsResponse.Item resource_type = 4;
    optional int32 resource_id = 5;
    google.protobuf.Timestamp created_at = 9;
  }
  repeated Item items = 1;
  Pagination pagination = 9;
}

// ----------------------------------------------------------------------------

service Locale {
  rpc Set(LocaleSetRequest) returns (google.protobuf.Empty) {}
  rpc Get(LocaleGetRequest) returns (LocaleIndexResponse.Item) {}
  rpc Index(Pager) returns (LocaleIndexResponse) {}
  rpc Destroy(IdRequest) returns (google.protobuf.Empty) {}
}

message LocaleIndexResponse {
  message Item {
    int32 id = 1;
    string lang = 2;
    string code = 3;
    string message = 4;
    google.protobuf.Timestamp updated_at = 9;
  }
  repeated Item items = 1;
  Pagination pagination = 9;
}

message LocaleGetRequest {
  string lang = 1;
  string code = 2;
}
message LocaleSetRequest {
  string lang = 1;
  string code = 2;
  string message = 3;
}

// ----------------------------------------------------------------------------

service Setting {
  rpc Set(SettingSetRequest) returns (google.protobuf.Empty) {}
  rpc Get(SettingGetRequest) returns (SettingGetResponse) {}
}

message SettingGetResponse { bytes value = 1; }

message SettingGetRequest {
  optional int32 user = 1;
  string key = 2;
}

message SettingSetRequest {
  optional int32 user = 1;
  string key = 2;
  bytes value = 3;
  bool encrypt = 9;
}

// ----------------------------------------------------------------------------

service Site {
  rpc Install(SiteInstallRequest) returns (google.protobuf.Empty) {}

  rpc ClearCache(google.protobuf.Empty) returns (google.protobuf.Empty) {}

  rpc Layout(google.protobuf.Empty) returns (SiteLayoutResponse) {}
  rpc SetAuthor(SiteLayoutResponse.Author) returns (google.protobuf.Empty) {}
  rpc SetCopyright(SiteSetCopyrightRequest) returns (google.protobuf.Empty) {}
  rpc SetKeywords(SiteSetKeywordsRequest) returns (google.protobuf.Empty) {}
  rpc SetInfo(SiteSetInfoRequest) returns (google.protobuf.Empty) {}
  rpc SetLogo(SiteSetLogoRequest) returns (google.protobuf.Empty) {}

  rpc IndexUser(Pager) returns (SiteUserIndexResponse) {}
  rpc ShowUser(IdRequest) returns (SiteUserIndexResponse.Item) {}
  rpc DisableUser(IdRequest) returns (google.protobuf.Empty) {}
  rpc EnableUser(IdRequest) returns (google.protobuf.Empty) {}
  rpc LockUser(IdRequest) returns (google.protobuf.Empty) {}
  rpc UnlockUser(IdRequest) returns (google.protobuf.Empty) {}
  rpc ConfirmUser(IdRequest) returns (google.protobuf.Empty) {}
  rpc SetUserPassword(SiteSetUserPasswordRequest)
      returns (google.protobuf.Empty) {}
  rpc ListUser(google.protobuf.Empty) returns (SiteListUserResponse) {}

  rpc SetAws(AwsProfile) returns (google.protobuf.Empty) {}
  rpc GetAws(google.protobuf.Empty) returns (AwsProfile) {}
  rpc TestAwsS3(google.protobuf.Empty) returns (SiteAwsS3TestResponse) {}
  rpc SetSmtp(SmtpProfile) returns (google.protobuf.Empty) {}
  rpc GetSmtp(google.protobuf.Empty) returns (SmtpProfile) {}
  rpc TestSmtp(SiteSmtpTestRequst) returns (google.protobuf.Empty) {}
  rpc SetBing(BingProfile) returns (google.protobuf.Empty) {}
  rpc GetBing(google.protobuf.Empty) returns (BingProfile) {}
  rpc SetGoogle(GoogleProfile) returns (google.protobuf.Empty) {}
  rpc GetGoogle(google.protobuf.Empty) returns (GoogleProfile) {}
  rpc SetBaidu(BaiduProfile) returns (google.protobuf.Empty) {}
  rpc GetBaidu(google.protobuf.Empty) returns (BaiduProfile) {}

  rpc Status(google.protobuf.Empty) returns (SiteStatusResponse) {}

  rpc NewLeaveWord(SiteNewLeaveWordRequest) returns (google.protobuf.Empty) {}
  rpc IndexLeaveWord(Pager) returns (SiteIndexLeaveWordResponse) {}
  rpc DestroyLeaveWord(IdRequest) returns (google.protobuf.Empty) {}
}

message AwsProfile {
  string region = 1;
  optional string endpoint = 2;
  string access_key_id = 3;
  string secret_access_key = 4;
}
message SiteAwsS3TestResponse { repeated string buckets = 1; }

message SiteListUserResponse {
  message Item {
    int32 id = 1;
    string nick_name = 2;
    string real_name = 3;
  }
  repeated Item items = 1;
}

message SiteSmtpTestRequst {
  string to = 1;
  string subject = 2;
  string body = 3;
}

message SiteSetLogoRequest { string url = 1; }
message SiteSetCopyrightRequest { string payload = 1; }
message SiteSetKeywordsRequest { repeated string items = 1; }
message SiteSetInfoRequest {
  string title = 1;
  string subhead = 2;
  string description = 3;
}

message SiteLayoutResponse {
  message Author {
    string name = 1;
    string email = 2;
  }
  message CurrentUser {
    SiteUserIndexResponse.Item payload = 1;
    bool is_administrator = 2;
    repeated PolicyPermission policies = 3;
  }
  string title = 1;
  string subhead = 2;
  repeated string keywords = 3;
  string description = 4;
  Author author = 5;
  string copyright = 6;
  string logo = 7;
  repeated string languages = 9;
  optional CurrentUser current_user = 11;
}

message SiteNewLeaveWordRequest { string body = 1; }
message SiteIndexLeaveWordResponse {
  message Item {
    int32 id = 1;
    string lang = 2;
    string ip = 3;
    string body = 4;
    google.protobuf.Timestamp created_at = 9;
  }
  repeated Item items = 1;
  Pagination pagination = 9;
}

message SiteInstallRequest { UserSignUpRequest user = 1; }

message SiteSetUserPasswordRequest {
  int32 user = 1;
  string password = 2;
}

message SiteUserIndexResponse {

  message Item {
    int32 id = 1;
    string uid = 2;
    string email = 3;
    string nick_name = 4;
    string real_name = 5;
    string provider_type = 6;
    google.protobuf.Timestamp updated_at = 9;
    optional google.protobuf.Timestamp last_sign_in_at = 11;
    optional string last_sign_in_ip = 12;
    optional google.protobuf.Timestamp current_sign_in_at = 13;
    optional string current_sign_in_ip = 14;
    int32 sign_in_count = 19;
    string lang = 21;
    string time_zone = 22;
    string avatar = 23;
    optional google.protobuf.Timestamp confirmed_at = 27;
    optional google.protobuf.Timestamp locked_at = 28;
    optional google.protobuf.Timestamp deleted_at = 29;
  }
  repeated Item items = 1;
  Pagination pagination = 9;
}

message GoogleProfile {
  // https://developers.google.com/recaptcha/intro
  message ReCaptcha {
    string site_key = 1;
    string secret = 2;
  }
  optional string site_verify_id = 1;
  optional ReCaptcha re_captcha = 2;
}
message BaiduProfile { optional string site_verify_id = 1; }
message BingProfile { optional string site_verify_id = 1; }

message SmtpProfile {
  string host = 1;
  uint32 port = 2;
  string user = 3;
  string password = 4;
  string cc = 5;
  string bcc = 6;
}

message SiteStatusResponse {
  message Database {
    string name = 1;
    string size = 2;
  }
  message PostgreSql {
    string version = 1;
    google.protobuf.Timestamp now = 2;
    repeated Database databases = 9;
  }
  message MySql {
    uint64 size = 1;
    string version = 2;
  }
  message Redis {
    message Item {
      string key = 1;
      int64 ttl = 2;
    };
    string info = 1;
    repeated Item items = 2;
  }
  message RabbitMq { string protocol = 1; }
  message ElasticSearch {}
  message Health {
    string name = 1;
    string status = 2;
  }
  message System {
    string version = 1;
    string cpu = 2;
    string memory = 3;
    string boot = 4;
    string disk = 5;
    string load = 6;
    string fs = 7;
    string swap = 8;
    string uptime = 9;
    string network = 10;
  }

  PostgreSql postgresql = 1;
  MySql mysql = 2;
  Redis redis = 3;
  RabbitMq rabbitmq = 4;
  ElasticSearch elasticsearch = 5;
  System system = 11;
  repeated Health healthes = 21;
}
